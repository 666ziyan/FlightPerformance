# Results

PROBLEM ONE: Among all the carriers that provide commercial services in U.S., are there any carriers that have major delay problems? For example, the average delay time is over 60 minutes.

```{r, airline delay count}
library(ggplot2)
data1 = filter(NY_Jan_cleaning,
               is.na(NY_Jan_cleaning$CARRIER_DELAY) == FALSE)
# data1 <- filter(NY_2020_cleaning,
#                is.na(NY_2020_cleaning$CARRIER_DELAY) == FALSE)
  
delayCount <- data1 %>%
  count(data1$MKT_CARRIER_AIRLINE_ID, name = "count", sort = TRUE)
delayCount$CARRIER_AIRLINE_ID <- format(delayCount$`data1$MKT_CARRIER_AIRLINE_ID`)
delayCount <- delayCount %>% 
  mutate(CARRIER_AIRLINE_ID = factor(CARRIER_AIRLINE_ID, levels = rev(CARRIER_AIRLINE_ID[order(count)])))
delayCount <- delayCount[, -1]
ggplot(data = delayCount, mapping = aes(x = CARRIER_AIRLINE_ID, 
                                        y = count)) +
  geom_bar(stat = 'identity', fill = '#FFAFAF', color = '#5584AC') +
  labs(x = "CARRIER AIRLINE ID", y = 'DELAY COUNT')
```

The dataframe `NY_Jan_delayCount` shows the number of delays for each carrier within the January. We plot a simple bar graph to manifest the result more explicitly. Note that this figure only shows the number of times that the delay occurs, on the other side, we need to evaluate the averaged severity of the delays, i.e. the averaged time of the delays for each carrier.

```{r, airline delay average}
delayAverage <- data1
delayAverage$delayTime <- rowSums(delayAverage[c(27:31)])
delayAverage <- delayAverage %>%
  group_by(delayAverage$MKT_CARRIER_AIRLINE_ID) %>%
  summarise(delayMean = mean(delayTime))

delayAverage$CARRIER_AIRLINE_ID <- format(delayAverage$`delayAverage$MKT_CARRIER_AIRLINE_ID`)

delayAverage <- delayAverage %>% 
  mutate(CARRIER_AIRLINE_ID = factor(CARRIER_AIRLINE_ID, levels = rev(CARRIER_AIRLINE_ID[order(delayMean)])))
delayAverage <- delayAverage[, -1]

ggplot(data = delayAverage, mapping = aes(x = CARRIER_AIRLINE_ID, y = delayMean)) +
  geom_bar(stat = 'identity', fill = ifelse(delayAverage$delayMean >= 60, '#95D1CC', '#577BC1'), color = '#161853') +
  geom_text(aes(label=round(delayMean, 2)), position=position_dodge(width=0.9), vjust=-0.25) +
  labs(x = "CARRIER AIRLINE ID", y = 'AVERAGED DELAY TIME / MINS')
```

Moreover, we hope to explore the results for concrete delay reasons, i.e. `CARRIER_DELAY`, `WEATHER_DELAY`, `NAS_DELAY`, `SECURITY_DELAY` and `LATE_AIRCRAFT_DELAY`, 

```{r, delay reason}
library(dplyr)
library(tidyverse)
library(gridExtra)
library(patchwork)
delayDetails <- data1
# setwd("~/Desktop")
for (i in 1:5) {
  delayDetail = filter(delayDetails, delayDetails[,(i+26)] != 0)
  delayDetailCount <- delayDetail %>%
    count(delayDetail$MKT_CARRIER_AIRLINE_ID, name = "count", sort = TRUE)
  delayDetailCount$CARRIER_AIRLINE_ID <- format(delayDetailCount$`delayDetail$MKT_CARRIER_AIRLINE_ID`)
  delayDetailCount <- delayDetailCount %>% 
    mutate(CARRIER_AIRLINE_ID = factor(CARRIER_AIRLINE_ID, levels = rev(CARRIER_AIRLINE_ID[order(count)])))
  delayDetailCount <- delayDetailCount[, -1]
  p1 <- ggplot(data = delayDetailCount, 
               mapping = aes(x = CARRIER_AIRLINE_ID, y = count)) +
    geom_bar(stat = 'identity', fill = '#FFAFAF', color = '#5584AC') +
    labs(x = "ID", y = 'COUNT') + 
    ggtitle(paste(colnames(delayDetails)[i+26], 'COUNT'))
  
  delayDetailAverage <- delayDetail
  delayDetailAverage$delayDetailCopy <- delayDetailAverage[,(i+26)]
  delayDetailAverage <- delayDetailAverage %>%
    group_by(delayDetailAverage$MKT_CARRIER_AIRLINE_ID) %>%
    summarise(delayDetailMean = mean(delayDetailCopy))
  delayDetailAverage$CARRIER_AIRLINE_ID <- format(delayDetailAverage$`delayDetailAverage$MKT_CARRIER_AIRLINE_ID`)
  delayDetailAverage <- delayDetailAverage %>% 
    mutate(CARRIER_AIRLINE_ID = factor(CARRIER_AIRLINE_ID, levels = rev(CARRIER_AIRLINE_ID[order(delayDetailMean)])))
  delayDetailAverage <- delayDetailAverage[, -1]
  p2 <- ggplot(data = delayDetailAverage, 
               mapping = aes(x = CARRIER_AIRLINE_ID, 
                             y=delayDetailMean)) +
    geom_bar(stat = 'identity', 
             fill = ifelse(delayDetailAverage$delayDetailMean >= 60,
                           '#95D1CC', '#577BC1'), color = '#161853') +
    geom_text(aes(label=round(delayDetailMean, 2)), 
              position=position_dodge(width=0.6), vjust=-0.25) +
    labs(x = "ID", y = 'AVE_TIME') + 
    ggtitle(paste(colnames(delayDetails)[i+26],'AVE_TIME'))
  
  p1 | p2
  p <- p1 + p2 + plot_layout(ncol = 2)
  print(p)
  
  # if (i == 1) {
  #   p <- p1 + p2
  # }
  # else{
  #   p <- p + p1 + p2  #很丑 #(很可爱了哈哈
  # }
  
  # filename <- paste(colnames(delayDetails)[(26+i)], ".pdf", sep = "")
  # ggsave(filename = filename)
  
}

```



PROBLEM TWO: Are early flights or late flights more likely to delay? Do origin and destination influence the on-time performance?

```{r, performance based on CRS_DEP_TIME}
# flight performance per 3h
# want to see if early or late flights delay more
# divide into groups and see delay performance?
# use NY_2019_cleaning


time_lv <- c("12am~3am", "3am~6am", "6am~9am", "9am~12pm",
             "12pm~3pm", "3pm~6pm", "6pm~9pm", "9pm~12am")

from_NY_2019 <- NY_2019_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY') ) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr=cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300))) %>% 
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean))
levels(from_NY_2019$dep_gr) = time_lv

from_NY_2020 <- NY_2020_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY')) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr=cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300))) %>% 
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean))
levels(from_NY_2020$dep_gr) = time_lv

# ggplot(from_NY_2019, aes(x=dep_gr)) + 
#   geom_point(aes(y=DEP_DELAY_Mean, color='Departure')) + 
#   geom_point(aes(y=ARR_DELAY_Mean, color='Arrival')) +
#   scale_colour_manual("", breaks=c('Departure','Arrival'), values=c('red','blue')) +
#   labs(x="CRS Departure Time", y="Average Delay (min)", title='Flight Performance from NY in 2019')
# 
# ggplot(from_NY_2020, aes(x=dep_gr)) + 
#   geom_point(aes(y=DEP_DELAY_Mean, color='Departure')) + 
#   geom_point(aes(y=ARR_DELAY_Mean, color='Arrival')) +
#   scale_colour_manual("", breaks=c('Departure','Arrival'), values=c('red','blue')) +
#   labs(x="CRS Departure Time", y="Average Delay (min)", title='Flight Performance from NY in 2020')

from_NY_2019$year <- "2019"
from_NY_2020$year <- "2020"
from_NY <- rbind(from_NY_2019, from_NY_2020)

ggplot(from_NY, aes(x=dep_gr, shape = year)) + 
  geom_point(aes(y = DEP_DELAY_Mean, color = 'Departure', size = 1)) + 
  geom_point(aes(y = ARR_DELAY_Mean, color = 'Arrival', size = 1)) +
  geom_hline(yintercept = 0, color = "#116530") + 
  scale_colour_manual("", breaks=c('Departure','Arrival'), values=c('#DD4A48','#064663')) +
  scale_discrete_manual(values = c(4,18), aesthetics = 'shape') +
  labs(x="CRS Departure Time", y="Average Delay (min)", title='Early / Late Flight Performance from NY') +
  scale_size_continuous(guide = F)
```

As we can see in the above plot, flight performance of 2020 is obviously better than in 2019. The green horizontal line at level 0 indicates the flight delays or not. Specifically, flights in 2020 almost arrive in advance to their destination no matter they departs lately or not. Unfortunately, flights in 2019 almost depart lately. Moreover, late flights seem to performance worse than early flights in general.

```{r}
time_lv <- c("12am~3am", "3am~6am", "6am~9am", "9am~12pm",
             "12pm~3pm", "3pm~6pm", "6pm~9pm", "9pm~12am")

time_lv_index <- c("0", "1", "2", "3", "4","5", "6", "7")

from_NY_2019_dest <- NY_2019_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY') ) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr=cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300)), DEST_STATE_ABR) %>% 
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean))
levels(from_NY_2019_dest$dep_gr) = time_lv_index

from_NY_2020_dest <- NY_2020_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY')) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr=cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300)), DEST_STATE_ABR) %>% 
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean))
levels(from_NY_2020_dest$dep_gr) = time_lv_index

from_NY_2019_dest$year <- "2019"
from_NY_2020_dest$year <- "2020"
from_NY_dest <- rbind(from_NY_2019_dest, from_NY_2020_dest)

ggplot(from_NY_dest, aes(x=dep_gr)) + 
  geom_point(aes(y = DEP_DELAY_Mean, color = year)) + 
  geom_hline(yintercept = 0, color = "#116530") + 
  scale_colour_manual(values=c('#DD4A48','#FBD148')) +
  labs(x="CRS Departure Time", y="Average Delay (min)", title='Early / Late Flight Performance from NY to US') +
  facet_wrap(~DEST_STATE_ABR, ncol=10)
  
```

The plot shows the performance of flights from NY to other states within US. Almost all subgraphs indicate similar conclusions in the previous picture, i.e. flight performance of 2020 is obviously better than in 2019, and also late flights seem to performance worse than early flights. Note that flights to some destinations e.g. HI, MT, NM, are only provided in certain periods, which may caused by the distance and passenger volume.

```{r}
library(stringr)
from_NY_2019_month <- NY_2019_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY') ) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr = cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300)), mon = str_sub(FL_DATE,6,7)) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean))
levels(from_NY_2019_month$dep_gr) = time_lv_index

from_NY_2020_month <- NY_2020_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY')) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr = cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300)), mon = str_sub(FL_DATE,6,7)) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean))
levels(from_NY_2020_month$dep_gr) = time_lv_index

from_NY_2019_month$year <- "2019"
from_NY_2020_month$year <- "2020"
from_NY_month <- rbind(from_NY_2019_month, from_NY_2020_month)

from_NY_month <- within(from_NY_month, mon <- factor(mon, levels = c("12", "03", "06", "09","01", "04", "07", "10","02", "05", "08", "11")))
with(from_NY_month, levels(mon))

ggplot(from_NY_month, aes(x=dep_gr)) + 
  geom_point(aes(y = DEP_DELAY_Mean, color = year)) + 
  geom_hline(yintercept = 0, color = "#116530") + 
  scale_colour_manual(values=c('#DD4A48','#FBD148')) +
  labs(x="CRS Departure Time", y="Average Delay (min)", title='Monthly Early / Late Flight Performance from NY') +
  facet_wrap(~mon, ncol=4)

```

The plot above shows flights performance in each months, which also yields the two conclusions mentioned berofe. Moreover, some other interesting observations are: (1) Note that in winter (Dec, Jan, Feb), flight performance is in general worse than in other seasons, especially for those late flights, which may due to the cold weather. (2) Season Fall seems to have the best flight performance.

```{r}
library(epade)
library(reshape2)

from_NY_2019_allu <- NY_2019_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY') ) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr = cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300)), FL_DATE) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean)) %>%
  group_by(mon = str_sub(FL_DATE,6,7))
levels(from_NY_2019_allu$dep_gr) = time_lv

from_NY_2020_allu <- NY_2020_cleaning %>%
  filter((ORIGIN_CITY_NAME=='New York, NY')) %>%
  arrange(CRS_DEP_TIME) %>%
  group_by(dep_gr = cut(CRS_DEP_TIME, breaks=seq(0, 2400, by=300)), FL_DATE) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean)) %>%
  group_by(mon = str_sub(FL_DATE,6,7))
levels(from_NY_2020_allu$dep_gr) = time_lv

from_NY_2019_allu$YEAR <- "2019"
from_NY_2020_allu$YEAR <- "2020"
from_NY_2019_allu$DATE <- str_sub(from_NY_2019_allu$FL_DATE,9,10)
from_NY_2020_allu$DATE <- str_sub(from_NY_2020_allu$FL_DATE,9,10)


from_NY_2019_dat = from_NY_2019_allu[, c(1,3,5)]
from_NY_2019_dat <- from_NY_2019_dat[, c("mon","dep_gr","DEP_DELAY_Mean")]
names(from_NY_2019_dat)[names(from_NY_2019_dat) == 'DEP_DELAY_Mean'] <- 'value'
par(las=2,cex=1.5)
tmp = dcast(from_NY_2019_dat, mon~dep_gr, mean)
tmp_data = as.matrix(tmp[, -1])
rownames(tmp_data) = tmp[, 1]
p1 <- bar3d.ade(t(tmp_data), wall = 1, xw = 0.3, zw = 1.2, xlab = "month", ylab = "ave-delay", main = "2019 month-period averaged delay")

from_NY_2020_dat = from_NY_2020_allu[, c(1,3,5)]
from_NY_2020_dat <- from_NY_2020_dat[, c("mon","dep_gr","DEP_DELAY_Mean")]
names(from_NY_2020_dat)[names(from_NY_2020_dat) == 'DEP_DELAY_Mean'] <- 'value'
par(las=2,cex=1.5)
tmp2 = dcast(from_NY_2020_dat, mon~dep_gr, mean)
tmp_data2 = as.matrix(tmp2[, -1])
rownames(tmp_data2) = tmp2[, 1]
p2 <- bar3d.ade(t(tmp_data2), wall = 3, xw = 0.6, zw = 1.8, xlab = "month", ylab = "ave-delay", main = "2020 month-period averaged delay")

```

3D plot is more powerful to show the variation of a quantity grouped by multi-indexes.

PROBLEM THREE: Specifically for NYC. If someone wants to come to NYC, which airport should s/he choose to fly to based on the origin city?


```{r, to NYC problem}
to_NY_2019 <- NY_2019_cleaning %>% 
  filter((DEST=='LGA') | (DEST=='JFK')) %>%
  # arrange(ORIGIN, CRS_DEP_TIME) %>%
  group_by(ORIGIN, DEST) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean)) %>%
  arrange(ORIGIN)

to_NY_2020 <- NY_2020_cleaning %>% 
  filter((DEST=='LGA') | (DEST=='JFK')) %>%
  # arrange(ORIGIN, CRS_DEP_TIME) %>%
  group_by(ORIGIN, DEST) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean)) %>%
  arrange(ORIGIN)

to_NY_Jan_19 <- Jan_19_cleaning %>% 
  filter((DEST=='LGA') | (DEST=='JFK') | (DEST =='EWR')) %>%
  group_by(ORIGIN, DEST) %>%
  summarise_at(vars(DEP_DELAY, ARR_DELAY), list(Mean=mean)) %>%
  arrange(ORIGIN) %>%
  group_by(DEST)

# ggplot(to_NY_Jan_19, aes(x=DEST)) 
```















